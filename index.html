<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solidity Compiler & Deployer</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-bottom: 10px;
    }
    pre {
      background: #eaeaea;
      padding: 10px;
      overflow-x: auto;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Smart Contract Compiler & Deployer</h2>

  <textarea id="code">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Hello {
    string public message = "Hello, Blockchain!";
}
  </textarea>

  <button onclick="compileContract()">Compile</button>
  <button onclick="deployContract()">Deploy</button>

  <h3>ABI</h3>
  <pre id="abi"></pre>

  <h3>Bytecode</h3>
  <pre id="bytecode"></pre>

  <h3>Deployed Address</h3>
  <pre id="address"></pre>

  <script>
    let solcLoaded = false;
    let solc;
    let compiledAbi = null;
    let compiledBytecode = null;

    function loadSolc() {
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/solc@0.8.21/soljson.min.js";
      script.onload = () => {
        window.Module = {};
        solc = window.solc;
        solcLoaded = true;
        console.log("solc-js loaded");
      };
      document.head.appendChild(script);
    }

    loadSolc();

    async function compileContract() {
      if (!solcLoaded || typeof solc.compile !== "function") {
        alert("Solidity compiler not ready yet. Please wait a few seconds.");
        return;
      }

      const source = document.getElementById("code").value;

      const input = {
        language: "Solidity",
        sources: {
          "Contract.sol": { content: source }
        },
        settings: {
          outputSelection: {
            "*": {
              "*": ["abi", "evm.bytecode"]
            }
          }
        }
      };

      try {
        const output = JSON.parse(solc.compile(JSON.stringify(input)));

        if (output.errors) {
          const messages = output.errors.map(err => err.formattedMessage).join("\n\n");
          alert("Compiler Messages:\n\n" + messages);
        }

        const contracts = output.contracts["Contract.sol"];
        const contractName = Object.keys(contracts)[0];
        const contract = contracts[contractName];

        compiledAbi = contract.abi;
        compiledBytecode = contract.evm.bytecode.object;

        document.getElementById("abi").textContent = JSON.stringify(compiledAbi, null, 2);
        document.getElementById("bytecode").textContent = compiledBytecode;
      } catch (err) {
        alert("Compilation error: " + err.message);
      }
    }

    async function deployContract() {
      if (!compiledAbi || !compiledBytecode) {
        alert("Compile the contract first.");
        return;
      }

      if (!window.ethereum) {
        alert("MetaMask not detected.");
        return;
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();

      const factory = new ethers.ContractFactory(compiledAbi, compiledBytecode, signer);

      try {
        const contract = await factory.deploy();
        await contract.deployed();
        document.getElementById("address").textContent = contract.address;
      } catch (err) {
        alert("Deployment failed: " + err.message);
      }
    }
  </script>

</body>
</html>
