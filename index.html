<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solidity Compiler & Deployer</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script src="https://binaries.soliditylang.org/bin/soljson-v0.8.21+commit.d9974bed.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    textarea { width: 100%; height: 200px; }
    pre { background: #eaeaea; padding: 10px; white-space: pre-wrap; }
    button { margin-top: 10px; margin-right: 10px; padding: 10px 20px; }
  </style>
</head>
<body>

<h2>Solidity Compiler + Deployer</h2>

<textarea id="sourceCode">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract HelloWorld {
    string public greet = "Hello Web3!";
}
</textarea>

<br>
<button onclick="compileContract()">Compile</button>
<button onclick="deployContract()">Deploy</button>

<h3>ABI</h3>
<pre id="abi"></pre>
<h3>Bytecode</h3>
<pre id="bytecode"></pre>
<h3>Deployed Address</h3>
<pre id="deployedAddress"></pre>

<script>
  let compiler;
  let compiledAbi;
  let compiledBytecode;

  window.onload = async () => {
    if (typeof window.Module !== 'undefined') {
      solc.setupMethods(require('solc'));
    }

    const compilerScript = window.Module || window.solc;
    if (!compilerScript) {
      alert("Solidity compiler failed to load.");
      return;
    }

    compiler = solc;
  };

  async function compileContract() {
    const source = document.getElementById("sourceCode").value;

    const input = {
      language: "Solidity",
      sources: {
        "Contract.sol": { content: source }
      },
      settings: {
        outputSelection: {
          "*": {
            "*": ["abi", "evm.bytecode"]
          }
        }
      }
    };

    const output = JSON.parse(compiler.compile(JSON.stringify(input)));
    const contract = output.contracts["Contract.sol"];
    const contractName = Object.keys(contract)[0];

    compiledAbi = contract[contractName].abi;
    compiledBytecode = contract[contractName].evm.bytecode.object;

    document.getElementById("abi").textContent = JSON.stringify(compiledAbi, null, 2);
    document.getElementById("bytecode").textContent = compiledBytecode;

    if (output.errors) {
      output.errors.forEach((e) => {
        if (e.severity === 'error') alert("Compiler Error:\n\n" + e.formattedMessage);
      });
    }
  }

  async function deployContract() {
    if (!compiledAbi || !compiledBytecode) {
      alert("Please compile first.");
      return;
    }

    if (!window.ethereum) {
      alert("MetaMask not detected.");
      return;
    }

    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();

    const factory = new ethers.ContractFactory(compiledAbi, compiledBytecode, signer);
    const contract = await factory.deploy();
    await contract.deployed();

    document.getElementById("deployedAddress").textContent = contract.address;
  }
</script>

</body>
</html>
