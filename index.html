<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solidity Compiler & Deployer</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://binaries.soliditylang.org/bin/soljson-v0.8.21+commit.d9974bed.js"></script>
  <style>
    body { font-family: monospace; background: #1e1e1e; color: #ddd; padding: 20px; }
    textarea { width: 100%; height: 300px; background: #111; color: #0f0; border: 1px solid #333; padding: 10px; }
    button { margin: 5px; padding: 10px 20px; background: #0f0; color: #111; border: none; cursor: pointer; }
    #output, #abi, #bytecode, #status, #contractName { background: #111; padding: 10px; margin-top: 10px; white-space: pre-wrap; border: 1px solid #444; }
    select { padding: 5px; background: #111; color: #fff; }
    .error { color: red; }
    .success { color: green; }
    .contract-output { color: #ffcc00; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Solidity Smart Contract Compiler & Deployer</h1>
  
  <!-- Compiler Status -->
  <div id="status">Loading compiler...</div>
  
  <!-- Contract Version Selector -->
  <label>Solidity Version (v0.8.21):</label>
  <select id="version" disabled>
    <option selected>v0.8.21</option>
  </select>
  
  <!-- Contract Code Input -->
  <textarea id="code">// Write your Solidity code here
pragma solidity ^0.8.21;

contract Test {
    uint public value;

    function set(uint _value) public {
        value = _value;
    }
}</textarea>

  <!-- Contract Actions -->
  <button onclick="compileContract()">Compile</button>
  <button onclick="deployContract()">Deploy</button>
  <button onclick="clearConsole()">Clear Console</button>
  <button onclick="clearState()">Clear State</button>

  <!-- Output Sections -->
  <div id="contractName"></div>
  <h3>Bytecode</h3>
  <div id="bytecode"></div>
  <h3>ABI</h3>
  <div id="abi"></div>
  <h3>Deployment Status</h3>
  <div id="output"></div>

  <!-- Gas estimation -->
  <h3>Gas Estimation</h3>
  <div id="gas"></div>

  <script>
    let solcReady = false;
    let compiledContract;
    let provider, signer;

    window.addEventListener('load', () => {
      if (typeof window.Module !== 'undefined') {
        window.solc = solc.setupMethods(solc);
        solcReady = true;
        document.getElementById('status').textContent = 'Compiler loaded';
        
        if (typeof window.ethereum !== 'undefined') {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          provider.send("eth_requestAccounts", []).then(() => {
            signer = provider.getSigner();
            log('MetaMask connected');
          });
        } else {
          log('MetaMask not detected');
        }
      } else {
        document.getElementById('status').innerHTML = '<span class="error">Compiler failed to load.</span>';
      }
    });

    function log(msg) {
      document.getElementById('output').innerText += msg + '\n';
    }

    function clearConsole() {
      document.getElementById('output').innerText = '';
      document.getElementById('bytecode').innerText = '';
      document.getElementById('abi').innerText = '';
      document.getElementById('gas').innerText = '';
    }

    function clearState() {
      document.getElementById('code').value = '';
      clearConsole();
    }

    function compileContract() {
      if (!solcReady) return log("Compiler not ready");

      const sourceCode = document.getElementById('code').value;
      const input = {
        language: "Solidity",
        sources: {
          "Contract.sol": {
            content: sourceCode
          }
        },
        settings: {
          outputSelection: {
            "*": {
              "*": ["abi", "evm.bytecode"]
            }
          }
        }
      };

      try {
        const output = JSON.parse(solc.compile(JSON.stringify(input)));
        if (output.errors) {
          output.errors.forEach(e => {
            const type = e.severity === 'error' ? '[ERROR]' : '[WARNING]';
            log(`${type} ${e.formattedMessage}`);
          });
        }

        const contractName = Object.keys(output.contracts["Contract.sol"])[0];
        compiledContract = output.contracts["Contract.sol"][contractName];
        document.getElementById('contractName').textContent = `Contract Name: ${contractName}`;

        log(`Compiled ${contractName}`);
        document.getElementById('bytecode').textContent = compiledContract.evm.bytecode.object;
        document.getElementById('abi').textContent = JSON.stringify(compiledContract.abi, null, 2);
      } catch (err) {
        log('[ERROR] ' + err.message);
      }
    }

    async function deployContract() {
      if (!compiledContract) return log("Compile first.");
      try {
        const factory = new ethers.ContractFactory(compiledContract.abi, compiledContract.evm.bytecode.object, signer);
        const gasEstimate = await factory.estimateGas();
        document.getElementById('gas').innerText = `Estimated Gas: ${gasEstimate.toString()}`;

        log("Deploying contract...");
        const contract = await factory.deploy();
        await contract.deployed();
        log("Contract deployed at: " + contract.address);

        log(`Transaction Hash: ${contract.deployTransaction.hash}`);
        log(`Block Number: ${contract.deployTransaction.blockNumber}`);
      } catch (err) {
        log('[DEPLOY ERROR] ' + err.message);
      }
    }
  </script>
</body>
</html>
